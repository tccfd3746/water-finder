<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± 300 å…¬å°ºæ¶ˆé˜²æ “æœå°‹èˆ‡å°èˆª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha204-Jj0p59h61Hw84D76gX+rPzK52t/u3aFw10d0y7lU3Z55W6aD05k2F5k49E2b3I0tB"
        crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        /* è¨­å®šåœ°åœ–å®¹å™¨çš„å¤§å° */
        #map {
            height: 100vh;
            width: 100%;
        }
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha204-GjJ7w+28zTfNlB/j6hO55/W27T2tU62/P0bW8d0K3pYw7V8w5f9aH5f5A3B9c7E7"
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // ============== æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒè¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ ==============

        const SEARCH_RADIUS_METERS = 300; // æ ¸å¿ƒåƒæ•¸ï¼šæœå°‹åŠå¾‘ (å…¬å°º)
        let watchId; // ç”¨æ–¼å„²å­˜ watchPosition çš„ ID
        let isWatching = true; // è¿½è¹¤ç‹€æ…‹æ¨™è¨˜
        let hydrantData = []; // å„²å­˜ GeoJSON è¼‰å…¥çš„è³‡æ–™
        let userMarker; // å„²å­˜ä½¿ç”¨è€…/æœå°‹ä½ç½®æ¨™è¨˜

        // åˆå§‹åŒ–åœ°åœ– (é è¨­è¦–è§’)
        const map = L.map('map').setView([24.1500, 120.6800], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap è²¢ç»è€…'
        }).addTo(map);


        // ============== è·é›¢è¨ˆç®—å‡½å¼ (Haversine å…¬å¼) ==============
        
        // ç”¨æ–¼è¨ˆç®—åœ°çƒä¸Šå…©é»é–“æº–ç¢ºè·é›¢çš„æ•¸å­¸å…¬å¼ (çµæœç‚ºå…¬é‡Œ)ã€‚
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // è·é›¢ (å…¬é‡Œ)
            return distance;
        }


        // ============== å®šä½èˆ‡æ¨™è¨˜é‚è¼¯ (é€šç”¨å‡½å¼ï¼Œæ”¯æ´å®šä½å’Œåœ°å€æœå°‹) ==============

        function findAndMarkHydrants(lat, lng, sourceName = "æ‚¨çš„ç›®å‰ä½ç½®") {
            const userLatLng = [lat, lng];
            
            // ç§»é™¤èˆŠçš„æ¨™è¨˜å’Œåœ“åœˆ
            map.eachLayer(layer => {
                if (layer !== map.tileLayer && !(layer instanceof L.Control)) {
                    map.removeLayer(layer);
                }
            });
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // 1. æ¨™è¨˜æœå°‹æˆ–å®šä½çš„ä¸­å¿ƒé»
            userMarker = L.marker(userLatLng).addTo(map)
                .bindPopup(`<b>${sourceName}</b>`).openPopup();
            
            // 2. è¨ˆç®—æ‰€æœ‰æ¶ˆé˜²æ “è·é›¢ä¸¦éæ¿¾å‡ºåœ¨ 300 å…¬å°ºå…§çš„ç›®æ¨™
            const nearbyHydrants = hydrantData.map(hydrant => {
                const distanceKm = getDistance(lat, lng, hydrant.lat, hydrant.lng);
                const distanceMeters = distanceKm * 1000;
                
                return {
                    ...hydrant,
                    distance: distanceMeters 
                };
            }).filter(hydrant => hydrant.distance <= SEARCH_RADIUS_METERS); 

            // 3. å°ç¯©é¸å¾Œçš„ç›®æ¨™é€²è¡Œæ’åº (ç”±è¿‘åˆ°é )
            nearbyHydrants.sort((a, b) => a.distance - b.distance); 

            // 4. è¨­å®šåœ°åœ–è¦–è§’å’Œç¸®æ”¾
            map.setView(userLatLng, 16); 

            // 5. ç¹ªè£½ 300 å…¬å°ºåœ“åœˆ
            L.circle(userLatLng, { 
                radius: SEARCH_RADIUS_METERS,
                color: 'blue', 
                fillColor: '#90b4e0', 
                fillOpacity: 0.2,
                weight: 2
            }).addTo(map);

            // 6. æ¨™è¨˜æ¶ˆé˜²æ “ä¸¦åŠ å…¥å°èˆªé€£çµ
            const fireHydrantIcon = L.icon({
                iconUrl: '
