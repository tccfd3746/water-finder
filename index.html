<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± æœ€è¿‘çš„æ¶ˆé˜²æ “å®šä½æœå‹™</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha204-Jj0p59h61Hw84D76gX+rPzK52t/u3aFw10d0y7lU3Z55W6aD05k2F5k49E2b3I0tB"
        crossorigin=""/>
    <style>
        /* è¨­å®šåœ°åœ–å®¹å™¨çš„å¤§å° */
        #map {
            height: 100vh;
            width: 100%;
        }
        /* è®“ç¶²é åœ¨æ‰‹æ©Ÿä¸Šä¿æŒå…¨è¢å¹•é¡¯ç¤º */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha204-GjJ7w+28zTfNlB/j6hO55/W27T2tU62/P0bW8d0K3pYw7V8w5f9aH5f5A3B9c7E7"
        crossorigin=""></script>

    <script>
        // ============== è®Šæ•¸èˆ‡åœ°åœ–åˆå§‹åŒ– ==============

        const map = L.map('map').setView([24.1500, 120.6800], 13); // é è¨­è¦–è§’ï¼šå°ä¸­å¸‚ä¸­å¿ƒ

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap è²¢ç»è€…'
        }).addTo(map);

        let userMarker;

        // ============== è·é›¢è¨ˆç®—å‡½å¼ (Haversine å…¬å¼) ==============
        
        // é€™æ˜¯è¨ˆç®—åœ°çƒä¸Šå…©é»é–“æº–ç¢ºè·é›¢çš„æ•¸å­¸å…¬å¼ã€‚
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // è·é›¢ (å…¬é‡Œ)
            return distance;
        }


        // ============== å®šä½èˆ‡æ¨™è¨˜é‚è¼¯ ==============

        // è™•ç†å®šä½æˆåŠŸçš„å‡½å¼ï¼šåœ¨é€™è£¡é€²è¡Œè·é›¢è¨ˆç®—å’Œæ¨™è¨˜
        function onLocationFound(pos, fireHydrantData) {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const userLatLng = [userLat, userLng];
            
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // 1. æ¨™è¨˜ä½¿ç”¨è€…ä½ç½® (è—è‰²åœ–æ¨™)
            userMarker = L.marker(userLatLng).addTo(map)
                .bindPopup("<b>æ‚¨çš„ç›®å‰ä½ç½®</b>").openPopup();
            
            map.setView(userLatLng, 15);
            
            // 2. è¨ˆç®—æ‰€æœ‰æ¶ˆé˜²æ “èˆ‡ä½¿ç”¨è€…çš„è·é›¢
            const hydrantsWithDistance = fireHydrantData.map(hydrant => {
                const distance = getDistance(userLat, userLng, hydrant.lat, hydrant.lng);
                return {
                    ...hydrant,
                    distance: distance // è·é›¢å–®ä½æ˜¯å…¬é‡Œ (km)
                };
            });
            
            // 3. æ’åºä¸¦å–å‡ºæœ€è¿‘çš„ä¸‰å€‹æ¶ˆé˜²æ “
            hydrantsWithDistance.sort((a, b) => a.distance - b.distance);
            const nearestHydrants = hydrantsWithDistance.slice(0, 3);
            
            // 4. ç§»é™¤èˆŠçš„æ¶ˆé˜²æ “æ¨™è¨˜
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });

            // 5. åœ¨åœ°åœ–ä¸Šæ¨™è¨˜æœ€è¿‘çš„ä¸‰å€‹æ¶ˆé˜²æ “ (ç´…è‰²åœ–æ¨™)
            const fireHydrantIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            nearestHydrants.forEach((hydrant, index) => {
                const distanceInMeters = (hydrant.distance * 1000).toFixed(0); // è½‰æ›ç‚ºå…¬å°º
                
                L.marker([hydrant.lat, hydrant.lng], { icon: fireHydrantIcon }).addTo(map)
                    .bindPopup(`
                        <b>ç¬¬ ${index + 1} è¿‘çš„æ¶ˆé˜²æ “: ${hydrant.name}</b><br>
                        è·é›¢: **${distanceInMeters} å…¬å°º**
                    `);
            });
            
            if (fireHydrantData.length === 0) {
                 L.popup()
                    .setLatLng(userLatLng)
                    .setContent("è­¦å‘Šï¼šGeoJSON è³‡æ–™è¼‰å…¥æˆåŠŸä½†ç‚ºç©ºã€‚è«‹æª¢æŸ¥ hydrants.geojson å…§å®¹ã€‚")
                    .openOn(map);
            }
        }

        // è™•ç†å®šä½å¤±æ•—çš„å‡½å¼
        function onLocationError(error) {
            let errorMessage = "ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹æª¢æŸ¥æ‚¨çš„å®šä½è¨­å®šæ˜¯å¦é–‹å•Ÿã€‚";
            
            if (error.code === error.PERMISSION_DENIED) {
                errorMessage = "æ‚¨æ‹’çµ•äº†å®šä½è«‹æ±‚ã€‚è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨æ‚¨çš„ä½ç½®ã€‚";
            }
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(`å®šä½å¤±æ•—ï¼š${errorMessage}`)
                .openOn(map);
        }


        // ============== æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é‚è¼¯ (GeoJSON è³‡æ–™è¼‰å…¥) ==============

        // è¼‰å…¥ä¸¦è§£æ GeoJSON æª”æ¡ˆ
        async function loadHydrantData() {
            try {
                // å˜—è©¦å¾ hydrants.geojson æª”æ¡ˆè¼‰å…¥è³‡æ–™
                const response = await fetch('hydrants.geojson'); 
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}ã€‚è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨ä¸¦é‹è¡Œæ–¼ä¼ºæœå™¨ã€‚`);
                }
                
                const geoJsonData = await response.json();
                
                // å°‡ GeoJSON æ ¼å¼è½‰æ›ç‚ºç¨‹å¼ç¢¼éœ€è¦çš„ { lat, lng, name } é™£åˆ—
                const processedData = geoJsonData.features
                    .filter(feature => feature.geometry && feature.geometry.type === 'Point')
                    .map(feature => {
                        const coords = feature.geometry.coordinates;
                        return {
                            // GeoJSON åº§æ¨™é †åºæ˜¯ [ç¶“åº¦ (lng), ç·¯åº¦ (lat)]
                            lat: coords[1], 
                            lng: coords[0],
                            // ç²å– GeoJSON å±¬æ€§ä¸­çš„åç¨±
                            name: feature.properties.name || feature.properties.Name || feature.properties.title || 'æœªçŸ¥æ¶ˆé˜²æ “'
                        };
                    });
                    
                return processedData;
                
            } catch (error) {
                console.error("è¼‰å…¥æ¶ˆé˜²æ “è³‡æ–™å¤±æ•—:", error);
                
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent(`è¼‰å…¥ GeoJSON å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±å’Œä¼ºæœå™¨è¨­å®šï¼š${error.message}`)
                    .openOn(map);
                return [];
            }
        }

        // æ‡‰ç”¨ç¨‹å¼ä¸»è¦å•Ÿå‹•é»
        async function initApp() {
            const hydrantData = await loadHydrantData();
            
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => onLocationFound(pos, hydrantData), 
                    onLocationError, 
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000,          
                        maximumAge: 0            
                    }
                );
            } else {
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ï¼Œç„¡æ³•é€²è¡Œå®šä½ã€‚")
                    .openOn(map);
            }
        }

        initApp();
    </script>

</body>
</html>