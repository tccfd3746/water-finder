<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± 300 å…¬å°ºæ¶ˆé˜²æ “æœå°‹èˆ‡å°èˆª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha204-Jj0p59h61Hw84D76gX+rPzK52t/u3aFw10d0y7lU3Z55W6aD05k2F5k49E2b3I0tB"
        crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        /* ç¢ºä¿åœ°åœ–å®¹å™¨æœ‰é«˜åº¦ */
        #map {
            height: 100vh;
            width: 100%;
        }
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        /* æ–°å¢ï¼šç”¨æ–¼é¡¯ç¤ºéŒ¯èª¤æç¤ºçš„è¦†è“‹å±¤ */
        #error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 50px;
            box-sizing: border-box;
            font-size: 1.2em;
            z-index: 10000;
            display: none; /* é è¨­éš±è— */
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="error-overlay">
        <h2>åœ°åœ–è¼‰å…¥å¤±æ•—ï¼</h2>
        <p>è«‹æª¢æŸ¥ä»¥ä¸‹å•é¡Œï¼š</p>
        <ol style="text-align: left; max-width: 400px; margin: 20px auto;">
            <li>ç€è¦½å™¨<b>é–‹ç™¼è€…å·¥å…· (F12)</b> çš„ Console æ¨™ç±¤æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯ã€‚</li>
            <li>Leaflet æˆ– GeoJSON æª”æ¡ˆæ˜¯å¦è¼‰å…¥å¤±æ•— (404 æˆ–é€£ç·šè¢«æ‹’)ã€‚</li>
            <li>ç¢ºèªç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚</li>
        </ol>
        <p>éŒ¯èª¤è©³æƒ…è«‹è¦‹ç€è¦½å™¨æ§åˆ¶å°ã€‚</p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha204-GjJ7w+28zTfNlB/j6hO55/W27T2tU62/P0bW8d0K3pYw7V8w5f9aH5f5A3B9c7E7"
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // ============== æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒè¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ ==============

        const SEARCH_RADIUS_METERS = 300; // æ ¸å¿ƒåƒæ•¸ï¼šæœå°‹åŠå¾‘ (å…¬å°º)
        let watchId; 
        let isWatching = true; 
        let hydrantData = []; 
        let userMarker; 
        let map; // ğŸŒŸ å®£å‘Šç‚ºå…¨åŸŸè®Šæ•¸ï¼Œä½†åœ¨ initMap è£¡åˆå§‹åŒ–

        // ============== è·é›¢è¨ˆç®—å‡½å¼ (Haversine å…¬å¼) ==============
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; 
            return distance;
        }

        // ğŸŒŸ åœ°åœ–åˆå§‹åŒ–å‡½å¼
        function initMap() {
             try {
                // æª¢æŸ¥ L ç‰©ä»¶æ˜¯å¦å·²å®šç¾© (ç¢ºä¿ Leaflet JS æˆåŠŸè¼‰å…¥)
                if (typeof L === 'undefined') {
                    throw new Error("Leaflet å‡½å¼åº« (L) è¼‰å…¥å¤±æ•—ï¼");
                }
                
                map = L.map('map').setView([24.1500, 120.6800], 13);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap è²¢ç»è€…'
                }).addTo(map);

                return true; // åˆå§‹åŒ–æˆåŠŸ
                
            } catch (e) {
                console.error("åœ°åœ–åˆå§‹åŒ–å¤±æ•—:", e.message);
                document.getElementById('error-overlay').style.display = 'block'; // é¡¯ç¤ºéŒ¯èª¤å±¤
                return false; // åˆå§‹åŒ–å¤±æ•—
            }
        }


        // ============== å®šä½èˆ‡æ¨™è¨˜é‚è¼¯ ==============

        function findAndMarkHydrants(lat, lng, sourceName = "æ‚¨çš„ç›®å‰ä½ç½®") {
            const userLatLng = [lat, lng];
            
            // ç§»é™¤èˆŠçš„æ¨™è¨˜å’Œåœ“åœˆ
            map.eachLayer(layer => {
                // é¿å…ç§»é™¤åœ°åœ–åœ–ç£šå’Œæ§åˆ¶é …
                if (layer !== map.tileLayer && !(layer instanceof L.Control)) {
                    map.removeLayer(layer);
                }
            });
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // 1. æ¨™è¨˜æœå°‹æˆ–å®šä½çš„ä¸­å¿ƒé»
            userMarker = L.marker(userLatLng).addTo(map)
                .bindPopup(`<b>${sourceName}</b>`).openPopup();
            
            // 2. è¨ˆç®—æ‰€æœ‰æ¶ˆé˜²æ “è·é›¢ä¸¦éæ¿¾
            const nearbyHydrants = hydrantData.map(hydrant => {
                const distanceKm = getDistance(lat, lng, hydrant.lat, hydrant.lng);
                const distanceMeters = distanceKm * 1000;
                
                return { ...hydrant, distance: distanceMeters };
            }).filter(hydrant => hydrant.distance <= SEARCH_RADIUS_METERS); 

            // 3. æ’åºèˆ‡è¦–è§’èª¿æ•´
            nearbyHydrants.sort((a, b) => a.distance - b.distance); 
            map.setView(userLatLng, 16); 

            // 4. ç¹ªè£½ 300 å…¬å°ºåœ“åœˆ
            L.circle(userLatLng, { 
                radius: SEARCH_RADIUS_METERS, color: 'blue', fillColor: '#90b4e0', fillOpacity: 0.2, weight: 2
            }).addTo(map);

            // 5. æ¨™è¨˜æ¶ˆé˜²æ “ä¸¦åŠ å…¥å°èˆªé€£çµ
            const fireHydrantIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            nearbyHydrants.forEach((hydrant, index) => {
                const distanceInMeters = hydrant.distance.toFixed(0); 
                const googleMapsUrl = `http://googleusercontent.com/maps.google.com/7{hydrant.lat},${hydrant.lng}&dir_action=navigate`;
                
                L.marker([hydrant.lat, hydrant.lng], { icon: fireHydrantIcon }).addTo(map)
                    .bindPopup(`
                        <b>æ¶ˆé˜²æ “ #${index + 1}: ${hydrant.name}</b><br>
                        è·é›¢: **${distanceInMeters} å…¬å°º**<br>
                        <hr style="margin: 5px 0;">
                        <a href="${googleMapsUrl}" target="_blank" 
                           style="display: block; padding: 5px; background-color: #4285F4; color: white; text-align: center; text-decoration: none; border-radius: 3px; font-weight: bold;">
                           ğŸš— é–‹å§‹å°èˆª (Google Maps)
                        </a>
                    `);
            });
            
            // 6. é¡¯ç¤ºçµæœæç¤º
            const resultCount = nearbyHydrants.length;
            const message = resultCount > 0 
                ? `åœ¨ ${SEARCH_RADIUS_METERS} å…¬å°ºå…§æ‰¾åˆ° ${resultCount} å€‹æ¶ˆé˜²æ “ã€‚`
                : `åœ¨ ${SEARCH_RADIUS_METERS} å…¬å°ºå…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ¶ˆé˜²æ “ã€‚`;

            if (sourceName !== "æ‚¨çš„ç›®å‰ä½ç½® (å³æ™‚)") {
                 L.popup().setLatLng(userLatLng).setContent(`<b>æœå°‹çµæœï¼š</b>${message}`).openOn(map);
            }
        }


        // ============== å®šä½è¿½è¹¤æ§åˆ¶å‡½å¼ (ä¿æŒä¸è®Š) ==============

        function onLocationFound(pos) {
            if (isWatching) {
                findAndMarkHydrants(pos.coords.latitude, pos.coords.longitude, "æ‚¨çš„ç›®å‰ä½ç½® (å³æ™‚)");
            }
        }
        function onLocationError(error) { /* ... ä¿æŒä¸è®Š ... */ }
        function stopWatching() { /* ... ä¿æŒä¸è®Š ... */ }
        function startWatching() { /* ... ä¿æŒä¸è®Š ... */ }


        // ============== æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é‚è¼¯ ==============

        async function loadHydrantData() {
            try {
                // ... ä¿æŒä¸è®Š (GeoJSON è¼‰å…¥)
                const response = await fetch('hydrants.geojson'); 
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                const geoJsonData = await response.json();
                
                return geoJsonData.features
                    .filter(feature => feature.geometry && feature.geometry.type === 'Point')
                    .map(feature => {
                        const coords = feature.geometry.coordinates;
                        return { lat: coords[1], lng: coords[0], name: feature.properties.name || feature.properties.Name || feature.properties.title || 'æœªçŸ¥æ¶ˆé˜²æ “' };
                    });
            } catch (error) {
                console.error("è¼‰å…¥æ¶ˆé˜²æ “è³‡æ–™å¤±æ•—:", error);
                
                L.popup().setLatLng(map.getCenter()).setContent(`è¼‰å…¥ GeoJSON å¤±æ•—ï¼š${error.message}`).openOn(map);
                return [];
            }
        }

        async function initApp() {
            // ğŸŒŸ 1. é¦–å…ˆå˜—è©¦åˆå§‹åŒ–åœ°åœ–
            if (!initMap()) {
                return; // å¦‚æœåœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œåœæ­¢å¾ŒçºŒæ“ä½œ
            }
            
            // 2. è¼‰å…¥è³‡æ–™
            hydrantData = await loadHydrantData();
            
            // 3. åŠ å…¥åœ°å€æœå°‹æ§åˆ¶é …
            L.Control.geocoder({
                placeholder: 'è¼¸å…¥åœ°å€æˆ–åœ°æ¨™...', defaultMarkGeocode: false 
            }).on('markgeocode', function(e) {
                stopWatching(); 
                const center = e.geocode.center;
                const name = e.geocode.name;
                findAndMarkHydrants(center.lat, center.lng, `æœå°‹åœ°é»: ${name}`);
            }).addTo(map);

            // 4. åŠ å…¥åœæ­¢/é–‹å§‹è¿½è¹¤æŒ‰éˆ•
            const StopControl = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function (map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    container.style.backgroundColor = 'white';
                    container.style.padding = '10px';
                    container.style.cursor = 'pointer';
                    container.id = 'watch-control';
                    container.innerHTML = 'ğŸ›‘ åœæ­¢å³æ™‚å®šä½';

                    container.onclick = function(){
                        if(isWatching) {
                            stopWatching();
                            container.innerHTML = 'ğŸŸ¢ é–‹å§‹å³æ™‚å®šä½';
                        } else {
                            startWatching();
                            container.innerHTML = 'ğŸ›‘ åœæ­¢å³æ™‚å®šä½';
                        }
                    }
                    return container;
                }
            });
            map.addControl(new StopControl());

            // 5. å•Ÿå‹•å³æ™‚å®šä½è¿½è¹¤
            startWatching();
        }

        initApp();
    </script>

</body>
</html>
